# =============================================================================
# Transformers Forge - CI: Release Preparation
# =============================================================================
# ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ€ÐµÐ»Ð¸Ð·Ð°: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° changelog, Ð²ÐµÑ€ÑÐ¸Ð¹, Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð° Ð¸Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
# =============================================================================

name: "ðŸš€ Release Preparation"

on:
  push:
    tags:
      - 'v*'
      - '*-forge.*'
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      dry_run:
        description: "Dry run (no actual release)"
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================================================
  # Validate release prerequisites
  # ===========================================================================
  validate:
    name: "âœ… Validate Release"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: extract-version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check version consistency
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          
          # Check __init__.py
          INIT_VERSION=$(python -c "import re; content = open('src/transformers/__init__.py').read(); m = re.search(r'__version__\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content); print(m.group(1) if m else '')")
          
          # Check setup.py
          SETUP_VERSION=$(python -c "import re; content = open('setup.py').read(); m = re.search(r'version\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content); print(m.group(1) if m else '')")
          
          # Check pyproject.toml
          PYPROJECT_VERSION=$(python -c "import re; content = open('pyproject.toml').read(); m = re.search(r'version\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content); print(m.group(1) if m else '')")
          
          echo "Version from tag/input: $VERSION"
          echo "__init__.py:            $INIT_VERSION"
          echo "setup.py:               $SETUP_VERSION"
          echo "pyproject.toml:         $PYPROJECT_VERSION"
          echo ""
          
          MISMATCH=0
          if [ "$INIT_VERSION" != "$VERSION" ]; then
            echo "âŒ __init__.py version mismatch!"
            MISMATCH=1
          fi
          if [ "$SETUP_VERSION" != "$VERSION" ]; then
            echo "âŒ setup.py version mismatch!"
            MISMATCH=1
          fi
          if [ "$PYPROJECT_VERSION" != "$VERSION" ]; then
            echo "âŒ pyproject.toml version mismatch!"
            MISMATCH=1
          fi
          
          if [ $MISMATCH -eq 1 ]; then
            echo ""
            echo "Please update all version files before releasing."
            exit 1
          fi
          
          echo "âœ… All versions match!"

      - name: Check CHANGELOG.md
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          
          if ! grep -q "$VERSION" CHANGELOG.md; then
            echo "âŒ Version $VERSION not found in CHANGELOG.md"
            echo "Please add release notes for this version."
            exit 1
          fi
          
          echo "âœ… CHANGELOG.md contains version $VERSION"

      - name: Validate package can be built
        run: |
          pip install build
          python -m build --sdist
          echo "âœ… Package builds successfully"

  # ===========================================================================
  # Run full test suite
  # ===========================================================================
  test:
    name: "ðŸ§ª Full Test Suite"
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[testing]"

      - name: Run tests
        run: |
          python -m pytest tests/generation/test_configuration_utils.py -v --tb=short

      - name: Verify all Enhanced fixes
        run: |
          python -c "
          from transformers import GenerationConfig
          from transformers.training_monitor import TrainingMonitor
          
          # Quick fix verification
          config = GenerationConfig(temperature=0.5)
          assert hasattr(config, '_explicitly_set_attrs')
          print('âœ… All Forge fixes verified')
          "

  # ===========================================================================
  # Build documentation
  # ===========================================================================
  docs:
    name: "ðŸ“š Build Docs"
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check documentation files exist
        run: |
          FILES=(
            "README.md"
            "CHANGELOG.md"
            "CONTRIBUTING_RU.md"
            "LICENSE"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing!"
              exit 1
            fi
          done

  # ===========================================================================
  # Create release artifacts
  # ===========================================================================
  build:
    name: "ðŸ“¦ Build Artifacts"
    needs: [validate, test, docs]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        run: |
          python -m build
          ls -la dist/

      - name: Check package
        run: |
          twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ needs.validate.outputs.version }}
          path: dist/
          retention-days: 30

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: "ðŸ“Š Release Summary"
    needs: [validate, test, docs, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Release Preparation: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "| Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Validation | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.docs.result }}" == "success" ]; then
            echo "| Documentation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Documentation | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "â„¹ï¸ This was a **dry run**. No actual release was created." >> $GITHUB_STEP_SUMMARY
          fi
