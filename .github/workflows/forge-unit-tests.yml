# ============================================================================
# Transformers Forge - Unit Tests CI
# ============================================================================
# 
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–¥—É–ª–µ–π Forge:
# - EMA (Exponential Moving Average)
# - Layer Utils
# - Training Presets
# - Training Monitor
#
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞:
# - Push –≤ main
# - Pull requests –≤ main
# - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (workflow_dispatch)
#
# ============================================================================

name: "üß™ Forge Unit Tests"

on:
  push:
    branches: [main]
    paths:
      - 'src/transformers/*.py'
      - 'tests/forge/**'
      - '.github/workflows/forge-unit-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/transformers/*.py'
      - 'tests/forge/**'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  # ==========================================================================
  # Main Test Job
  # ==========================================================================
  test:
    name: "üß™ Run Forge Tests"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      # ----------------------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------------------
      - name: "üì• Checkout repository"
        uses: actions/checkout@v4
      
      # ----------------------------------------------------------------------
      # Python Setup
      # ----------------------------------------------------------------------
      - name: "üêç Set up Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      # ----------------------------------------------------------------------
      # Cache pip dependencies
      # ----------------------------------------------------------------------
      - name: "üì¶ Cache pip dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-
      
      # ----------------------------------------------------------------------
      # Install dependencies
      # ----------------------------------------------------------------------
      - name: "üì¶ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          # Install PyTorch CPU version (faster, smaller)
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # Install project in editable mode
          pip install -e . --no-deps
          # Install minimal dependencies
          pip install packaging filelock regex requests safetensors tqdm pyyaml huggingface-hub tokenizers
      
      # ----------------------------------------------------------------------
      # Show environment info
      # ----------------------------------------------------------------------
      - name: "‚ÑπÔ∏è Show environment info"
        run: |
          echo "Python version:"
          python --version
          echo ""
          echo "PyTorch version:"
          python -c "import torch; print(torch.__version__)"
          echo ""
          echo "Transformers Forge version:"
          python -c "import transformers; print(transformers.__version__)"
      
      # ----------------------------------------------------------------------
      # Run Forge unit tests
      # ----------------------------------------------------------------------
      - name: "üß™ Run Forge unit tests"
        run: |
          pytest tests/forge/ -v --tb=short --color=yes
      
      # ----------------------------------------------------------------------
      # Test Summary
      # ----------------------------------------------------------------------
      - name: "üìä Test Summary"
        if: always()
        run: |
          echo "=============================================="
          echo "üß™ FORGE UNIT TESTS COMPLETED"
          echo "=============================================="
          echo "Python: ${{ matrix.python-version }}"
          echo "OS: ubuntu-latest"
          echo "=============================================="

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  summary:
    name: "üìä Tests Summary"
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: "üìä Summary"
        run: |
          echo "=============================================="
          echo "üî® TRANSFORMERS FORGE - TEST RESULTS"
          echo "=============================================="
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ All tests passed!"
          else
            echo "‚ùå Some tests failed"
            exit 1
          fi
